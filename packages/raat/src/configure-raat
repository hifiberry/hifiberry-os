#!/bin/bash
# Read UUID from /etc/uuid
UUID=`cat /etc/uuid`

CARD=`aplay -l | grep -i hifiberry`
DIGI=`echo $CARD | grep -i digi`
if [ "$DIGI" != "" ]; then
 CARD="Digi+"
else
 CARD="DAC+"
fi
DRIVER=`aplay -l | grep "\[snd_rpi" | awk -F\[ '{print $2}' | awk -F\] '{print $1}'`
VERSION=`###MYVERSION###`

DIGIFIXED=0
DIGIDOP=0
LINEARVOLUME=0

echo Configuring RAAT server for UUID $UUID on $CARD \($DRIVER\)

# Generate correct mixer controls:
VOLCTL='"volume": { "type": "software" }'
MAXFS=192000
DSD=""
SIGNALTYPE="analog"

MIXER=$(config-soundcard --volume-control-softvol)
MIXER_HW=$(config-soundcard --hw)

VOLCTL="\"volume\": { \"type\": \"alsa\", \"optional\": \"false\", \"device\": \"hw:$MIXER_HW\", \"index\":0, \"name\": \"$MIXER\", \"mode\":\"number\" },"
MAXFS=192000

PLAYBACKDEVICE="default"

cat <<END >/var/lib/raat/hifiberry.conf
{
    "_comment":   "This file is generated by HiFiBerry. Do not edit manually.",
    "vendor":      "HiFiBerry",
    "model":       "$CARD",
    "unique_id":   "$UUID",
    "output":      { "type": "alsa", 
                     "device": "$PLAYBACKDEVICE",
                     "max_pcm_rate": $MAXFS,
                     $DSD
                     "signal_path": [ { "quality": "lossless", "type": "output", "method": "$SIGNALTYPE" } ],
		     "supported_formats": [ 
                         {"sample_type": "pcm", "sample_rate": 44100, "bits_per_sample": 16, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 44100, "bits_per_sample": 24, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 44100, "bits_per_sample": 32, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 88200, "bits_per_sample": 16, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 88200, "bits_per_sample": 24, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 88200, "bits_per_sample": 32, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 176400, "bits_per_sample": 16, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 176400, "bits_per_sample": 24, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 176400, "bits_per_sample": 32, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 48000, "bits_per_sample": 16, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 48000, "bits_per_sample": 24, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 48000, "bits_per_sample": 32, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 96000, "bits_per_sample": 16, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 96000, "bits_per_sample": 24, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 96000, "bits_per_sample": 32, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 192000, "bits_per_sample": 16, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 192000, "bits_per_sample": 24, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 192000, "bits_per_sample": 32, "channels": 2}
                     ]
                   },
$VOLCTL
    "version":     "$VERSION",
    "transport":   { "type": "hifiberry" }
}
END
