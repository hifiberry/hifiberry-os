#!/bin/bash
# Read UUID from /etc/uuid
UUID=`cat /etc/uuid`

CARD=`aplay -l | grep -i hifiberry`
DIGI=`echo $CARD | grep -i digi`
if [ "$DIGI" != "" ]; then
 CARD="Digi+"
else
 CARD="DAC+"
fi
DRIVER=`aplay -l | grep "\[snd_rpi" | awk -F\[ '{print $2}' | awk -F\] '{print $1}'`
VERSION=`###MYVERSION###`

DIGIFIXED=0
DIGIDOP=0
LINEARVOLUME=0

echo Configuring RAAT server for UUID $UUID on $CARD \($DRIVER\)

# Generate correct mixer controls:
VOLCTL='"volume": { "type": "software" }'
MAXFS=192000
DSD=""
SIGNALTYPE="analog"

MIXER=Softvol
# Check if Pipewire is running
if pgrep -x "pipewire" > /dev/null; then
    echo "Using Pipewire volume control"
    MIXER=Master
fi

V1='"volume": { "type": "alsa", "optional": "false", "device":"default", "index":0, "name":'
V2=\"$MIXER\"
V3=', "mode":"number" },'
VOLCTL=$V1$V2$V3
MAXFS=192000
 
# Allow user to set softvol in RAAT. This is incompatible with volume control for other services!
if [ -f "/etc/hifiberry_raat.softvol" ]; then
 VOLCTL='"volume": { "type": "software" },'
fi

PLAYBACKDEVICE="default"


cat <<END >/usr/share/raat/hifiberry_raat.conf
{
    "vendor":      "HiFiBerry",
    "model":       "$CARD",
    "unique_id":   "$UUID",
    "output":      { "type": "alsa", 
                     "device": "$PLAYBACKDEVICE",
                     "max_pcm_rate": $MAXFS,
                     $DSD
                     "signal_path": [ { "quality": "lossless", "type": "output", "method": "$SIGNALTYPE" } ],
		     "supported_formats": [ 
                         {"sample_type": "pcm", "sample_rate": 44100, "bits_per_sample": 16, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 44100, "bits_per_sample": 24, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 44100, "bits_per_sample": 32, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 88200, "bits_per_sample": 16, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 88200, "bits_per_sample": 24, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 88200, "bits_per_sample": 32, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 176400, "bits_per_sample": 16, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 176400, "bits_per_sample": 24, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 176400, "bits_per_sample": 32, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 48000, "bits_per_sample": 16, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 48000, "bits_per_sample": 24, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 48000, "bits_per_sample": 32, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 96000, "bits_per_sample": 16, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 96000, "bits_per_sample": 24, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 96000, "bits_per_sample": 32, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 192000, "bits_per_sample": 16, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 192000, "bits_per_sample": 24, "channels": 2},
                         {"sample_type": "pcm", "sample_rate": 192000, "bits_per_sample": 32, "channels": 2}
                     ]
                   },
$VOLCTL
    "version":     "$VERSION",
    "transport":   { "type": "hifiberry" }
}
END
