#!/bin/bash
set -e

# Create shairport-sync group if it doesn't exist
if ! getent group shairport-sync > /dev/null; then
    addgroup --system shairport-sync
fi

# Create shairport-sync user if it doesn't exist
if ! getent passwd shairport-sync > /dev/null; then
    adduser --system --ingroup shairport-sync --home /var/lib/shairport-sync --no-create-home --shell /usr/sbin/nologin shairport-sync
    usermod -a -G audio shairport-sync
fi

# Create nqptp group if it doesn't exist
if ! getent group nqptp > /dev/null; then
    addgroup --system nqptp
fi

# Create nqptp user if it doesn't exist
if ! getent passwd nqptp > /dev/null; then
    adduser --system --ingroup nqptp --home /var/lib/nqptp --no-create-home --shell /usr/sbin/nologin nqptp
fi

# Add shairport-sync user to pipewire group for PipeWire integration
if getent group pipewire > /dev/null; then
    usermod -a -G pipewire shairport-sync || true
fi

# Create lib directory for shairport-sync
if [ ! -d /var/lib/shairport ]; then
    mkdir -p /var/lib/shairport
    chown shairport-sync:shairport-sync /var/lib/shairport
    chmod 755 /var/lib/shairport
fi

# Create runtime directory for shairport-sync (for backwards compatibility if needed)
if [ ! -d /var/run/shairport ]; then
    mkdir -p /var/run/shairport
    chown shairport-sync:shairport-sync /var/run/shairport
    chmod 755 /var/run/shairport
fi

# Set capabilities for nqptp
if command -v setcap > /dev/null; then
    setcap 'cap_net_bind_service=+ep' /usr/bin/nqptp || true
fi

# Handle systemd service management based on installation type
case "$1" in
    configure)
        # Fresh installation - debhelper will handle service enabling
        if [ -z "$2" ]; then
            echo "Fresh installation - services will be enabled by debhelper"
        else
            echo "Package upgrade - services will be handled by debhelper"
        fi
        ;;
    
    abort-upgrade|abort-remove|abort-deconfigure)
        # Nothing to do in these cases
        ;;
esac

#DEBHELPER#
