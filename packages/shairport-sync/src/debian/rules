#!/usr/bin/make -f

%:
	dh $@

override_dh_auto_configure:
	# Download and build NQPTP first
	@echo "Building NQPTP..."
	git clone https://github.com/mikebrady/nqptp.git nqptp
	cd nqptp && git checkout 1.2.4
	cd nqptp && autoreconf -fi && ./configure --with-systemd-startup && make
	
	# Download and build metadata reader
	@echo "Building metadata reader..."
	git clone https://github.com/mikebrady/shairport-sync-metadata-reader.git metadata-reader
	cd metadata-reader && autoreconf -fi && ./configure && make
	
	# Download and configure shairport-sync
	@echo "Downloading and configuring shairport-sync..."
	wget https://github.com/mikebrady/shairport-sync/archive/refs/tags/4.3.7.tar.gz -O shairport-sync-4.3.7.tar.gz
	tar -xzf shairport-sync-4.3.7.tar.gz
	cd shairport-sync-4.3.7 && autoreconf -fi
	cd shairport-sync-4.3.7 && ./configure --prefix=/usr --sysconfdir=/etc --with-airplay-2 --with-ssl=openssl --with-mqtt-client --with-dbus-interface --with-mpris-interface --with-systemd --with-avahi --with-alsa --with-soxr --with-pipe --with-stdout --with-metadata

override_dh_auto_build:
	# Build shairport-sync
	cd shairport-sync-4.3.7 && make

override_dh_auto_install:
	# Install shairport-sync
	cd shairport-sync-4.3.7 && sed -i '/getent group/d' Makefile && sed -i '/getent passwd/d' Makefile && sed -i '/cp \.\/scripts\/shairport-sync\.conf/d' Makefile
	cd shairport-sync-4.3.7 && make install DESTDIR=$(CURDIR)/debian/hifiberry-shairport AM_UPDATE_INFO_DIR=no
	
	# Remove any .sh scripts installed by upstream that we'll replace
	rm -f $(CURDIR)/debian/hifiberry-shairport/usr/bin/*.sh
	
	# Remove any upstream systemd service files that we'll replace
	rm -f $(CURDIR)/debian/hifiberry-shairport/lib/systemd/system/shairport-sync.service
	
	# Remove any upstream systemd service files that conflict with ours
	rm -f $(CURDIR)/debian/hifiberry-shairport/lib/systemd/system/shairport-sync.service
	rm -f $(CURDIR)/debian/hifiberry-shairport/usr/lib/systemd/system/shairport-sync.service
	rm -f $(CURDIR)/debian/hifiberry-shairport/shairport-sync.service	
	
	# Install systemd service files
	install -D -m644 systemd/shairport.service $(CURDIR)/debian/hifiberry-shairport/lib/systemd/system/shairport.service
	install -D -m644 systemd/nqptp.service $(CURDIR)/debian/hifiberry-shairport/lib/systemd/system/nqptp.service
	
	# Install NQPTP binary and man page
	install -D -m755 nqptp/nqptp $(CURDIR)/debian/hifiberry-shairport/usr/bin/nqptp
	if [ -f "nqptp/nqptp.1" ]; then \
		install -D -m644 nqptp/nqptp.1 $(CURDIR)/debian/hifiberry-shairport/usr/share/man/man1/nqptp.1; \
	else \
		install -D -m644 man/nqptp.1 $(CURDIR)/debian/hifiberry-shairport/usr/share/man/man1/nqptp.1; \
	fi
	
	# Install metadata reader
	install -D -m755 metadata-reader/shairport-sync-metadata-reader $(CURDIR)/debian/hifiberry-shairport/usr/bin/shairport-sync-metadata-reader
	install -D -m644 man/shairport-sync-metadata-reader.1 $(CURDIR)/debian/hifiberry-shairport/usr/share/man/man1/shairport-sync-metadata-reader.1
	
	# Install custom scripts (remove .sh extensions)
	install -D -m755 start-shairport.sh $(CURDIR)/debian/hifiberry-shairport/usr/bin/start-shairport
	install -D -m755 shairport-event.sh $(CURDIR)/debian/hifiberry-shairport/usr/bin/shairport-event
	install -D -m755 shairport-metadata-example.sh $(CURDIR)/debian/hifiberry-shairport/usr/bin/shairport-metadata-example
	install -D -m755 shairport-playpause.sh $(CURDIR)/debian/hifiberry-shairport/usr/bin/shairport-playpause
	
	# Install man pages for event scripts
	install -D -m644 man/start-shairport.1 $(CURDIR)/debian/hifiberry-shairport/usr/share/man/man1/start-shairport.1
	install -D -m644 man/shairport-event-start.1 $(CURDIR)/debian/hifiberry-shairport/usr/share/man/man1/shairport-event-start.1
	install -D -m644 man/shairport-event-stop.1 $(CURDIR)/debian/hifiberry-shairport/usr/share/man/man1/shairport-event-stop.1
	install -D -m644 man/shairport-event.1 $(CURDIR)/debian/hifiberry-shairport/usr/share/man/man1/shairport-event.1
	install -D -m644 man/shairport-metadata-example.1 $(CURDIR)/debian/hifiberry-shairport/usr/share/man/man1/shairport-metadata-example.1
	install -D -m644 man/shairport-playpause.1 $(CURDIR)/debian/hifiberry-shairport/usr/share/man/man1/shairport-playpause.1
	
	# Install default configuration file
	install -D -m644 shairport-sync.conf.default $(CURDIR)/debian/hifiberry-shairport/etc/shairport-sync.conf.default
	
	# Create symlinks for start and stop scripts (these point to the event handler)
	mkdir -p $(CURDIR)/debian/hifiberry-shairport/usr/bin/
	ln -sf /usr/bin/shairport-event $(CURDIR)/debian/hifiberry-shairport/usr/bin/shairport-event-start
	ln -sf /usr/bin/shairport-event $(CURDIR)/debian/hifiberry-shairport/usr/bin/shairport-event-stop

override_dh_auto_clean:
	rm -rf nqptp/
	rm -rf metadata-reader/
	rm -rf shairport-sync-4.3.7/
	rm -f shairport-sync-4.3.7.tar.gz

override_dh_auto_test:
	# Skip tests - requires audio hardware and network setup
